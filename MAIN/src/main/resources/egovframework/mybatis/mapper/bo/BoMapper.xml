<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.main.mvc.mapper.bo.BoMapper">
	
	<select id="channelList" resultType="Bo1010Dto">
		SELECT CHID as chId
		     , CHNO as chNo
		     , CHNAME as chName
		     , CHOPENNAME as chOpenName
		     , CHUSERCOUNT as chUserCount
		     , REGDATE as regDate
		     , MODDATE as modDate
		     , USEYN as useYn
		  FROM HYCHANNEL
		 WHERE 1=1
		 <if test='chName != null and chName != "" '>
		   AND CHNAME LIKE '%' || #{chName} || '%'
		 </if>
	</select>
	
	<select id="channelHeader" resultType="Bo1010Dto" parameterType="Bo1010Dto">
		SELECT CHID as chId
		     , CHNO as chNo
		     , CHNAME as chName
		     , CHOPENNAME as chOpenName
		     , CHUSERCOUNT as chUserCount
		     , REGDATE as regDate
		     , MODDATE as modDate
		     , USEYN as useYn
		  FROM HYCHANNEL
		 WHERE CHID = #{chId}
	</select>
	
	<select id="channelDetailList" resultType="Bo1010Dto">
		SELECT CHID as chId
		     , CHDEID as chDeId
		     , CHDENO as chDeNo
		     , CHNAME as chName
		     , REGUSERID as regUserId
		     , REGNICKNAME as regNickName
		     , TITLE as title
		     , CONTENT as content
		     , NVL(INCHECK, 0) as inCheck
		     , REGDATE as regDate
		     , MODDATE as modDate
		     , USEYN as useYn
		  FROM HYCHANNELDE
		 WHERE useYn = 'Y'
		   AND CHID = #{chId}
		 ORDER BY TO_NUMBER(chDeNo) DESC
	</select>
	
	<select id="channelDetatilData" resultType="Bo1010Dto">
		SELECT CHID as chId
		     , CHDEID as chDeId
		     , CHDENO as chDeNo
		     , CHNAME as chName
		     , REGUSERID as regUserId
		     , REGNICKNAME as regNickName
		     , TITLE as title
		     , CONTENT as content
		     , INCHECK as inCheck
		     , REGDATE as regDate
		     , MODDATE as modDate
		     , USEYN as useYn
		  FROM HYCHANNELDE
		 WHERE useYn = 'Y'
		   AND CHDEID = #{chDeId}
	</select>
	
	<select id="commentList" resultType="Bo1010Dto">
		SELECT cdc.chdeId as chdeId
		     , cdc.chdeCommentId as chdeCommentId
		     , cdc.regUserId as regUserId
		     , cdc.regNickName as regNickName
		     , cdc.deComment as deComment
		     , cdc.commentLine as commentLine
		     , cdc.regDate as regDate
		     , cdc.modDate as modDate
		     , us.profileImg as profileImg
		  FROM HYCHANNELDECOMMENT cdc
		  LEFT OUTER JOIN HYUSERS us
		    ON cdc.REGUSERID = us.userId
		   AND us.useYn = 'Y' 
		 WHERE cdc.useYn = 'Y'
		   AND chdeId = #{chDeId}
		 ORDER BY cdc.commentLine ASC
	</select>
	
	<select id="commentConut" resultType="Bo1010Dto"> 
		SELECT COUNT(*) as commentCount
		  FROM HYCHANNELDECOMMENT
		 WHERE chdeId = #{chDeId}
	</select>
	
	<insert id="commentInsert">
		INSERT INTO HYCHANNELDECOMMENT 
	          ( CHDEID
	          , CHDECOMMENTID
	          , REGUSERID
	          , REGNICKNAME
	          , DECOMMENT
	          , COMMENTLINE
	          , REGDATE
	          , MODDATE
	          , USEYN) 
	   VALUES ( #{chDeId},
	            reqSeqId('CHDECOM'),
	            #{regUserId},
	            #{regNickName},
	            #{deComment},
	            #{commentLine},
	            to_char(sysdate, 'YYYY-MM-DD'),
	            '',
	            'Y')
	</insert>
	
	<select id="contentConut" resultType="Bo1010Dto"> 
		SELECT COUNT(*) + 1 as contentCount
		  FROM HYCHANNELDE
		 WHERE chId = #{chId}
	</select>
	
	<insert id="contentInsert">
		INSERT INTO HYCHANNELDE 
		          ( CHID
		          , CHDEID
		          , CHDENO
		          , CHNAME
		          , REGUSERID
		          , REGNICKNAME
		          , TITLE
		          , CONTENT
		          , REGDATE
		          , MODDATE
		          , USEYN
		          , INCHECK) 
		     VALUES 
		          ( #{chId}
		          , reqSeqId('CHDE')
		          , #{chNo}
		          , #{chName}
		          , #{regUserId}
		          , #{regNickName}
		          , #{title}
		          , #{content}
		          , to_char(sysdate, 'YYYY-MM-DD')
		          , ''
		          , 'Y'
		          , '')
	</insert>
	
	<update id="contentIncheck">
		UPDATE HYCHANNELDE
		   SET inCheck = NVL2(inCheck, inCheck+1, 1)
		 WHERE chDeId = #{chDeId}
		   AND useYn = 'Y'
	</update>
	
	<select id="channelCount" resultType="Bo1010Dto">
		SELECT COUNT(*) +1 as channelCount 
  		  FROM HYCHANNEL
	</select>
	
	<insert id="channelInsert">
		  INSERT INTO HYCHANNEL 
		            ( CHID
		            , CHNO
		            , CHNAME
		            , CHOPENNAME
		            , CHUSERCOUNT
		            , REGDATE
		            , MODDATE
		            , USEYN)
		       VALUES ( reqSeqId('CH')
		            , #{channelCount}
		            , #{chName}
		            , #{chOpenName}
		            , '0'
		            , to_char(sysdate, 'YYYY-MM-DD')
		            , ''
		            , 'Y'
		            )
	</insert>
	
	<select id="contentMyList" resultType="Bo1010Dto">
		 SELECT chId as chId
		      , chDeId as chDeId
		      , chDeNo as chDeNo
		      , chName as chName
		      , regUserId as regUserId
		      , regNickName as regNickName
		      , title as title
		      , regDate as regDate
		      , inCheck as inCheck
		   FROM HYCHANNELDE
	 	  WHERE regUserId = #{regUserId}
	 	  ORDER BY chName, chDeno
	</select>
	
	<select id="subScrYn" resultType="Bo1010Dto">
		SELECT CASE WHEN COUNT(*) > 0 
		       THEN 'Y'
		       ELSE 'N'
		        END as subScrYn
		  FROM HYCHANNELSCR
		 WHERE userId = #{userId}
		   AND chId = #{chId}
	</select>
	
	<insert id="subScribe">
		INSERT INTO HYCHANNELSCR 
          ( CHID
          , CHIDNO
          , CHNAME
          , USERID
          , REGDATE
          , MODDATE
          , USEYN
          ) VALUES
          ( #{chId}
          , (SELECT NVL(COUNT(CHID), 0) + 1 
               FROM HYCHANNELSCR 
              WHERE userId = #{userId})
          , #{chName}
          , #{userId}
          , to_char(sysdate, 'YYYY-MM-DD')
          , ''
          , 'Y'
          )
	</insert>
	
	
	<select id="scrContentList" resultType="Bo1010Dto">
		SELECT cs.chId as chId
		     , cd.chDeId as chDeId
		     , cd.chName as chName
		     , cd.title as title
		     , cs.userId as userId
		     , cd.regDate as regDate
		     , cd.inCheck as inCheck
		     , '바로가기' as boardClick
		  FROM HYCHANNELDE cd
		  LEFT OUTER JOIN HYCHANNELSCR cs
		    ON cd.chId = cs.chId
		   AND cd.regUserId = cs.userId
		   AND cd.useYn = 'Y'
		 WHERE cs.useYn = 'Y'
		   AND cd.regUserId = #{userId}
		ORDER BY cd.regDate DESC
	</select>
	
</mapper>